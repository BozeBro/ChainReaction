<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/index.css">
    <link rel="stylesheet" href="/static/css/waiting.css">
    <link rel="stylesheet" href="/static/css/game.css">
    <!-- We need index.css for the btn style -->
    <title>Chain Reaction Game</title>
</head>

<body>
    <div class="overview">
        <div>
            <span class="navHome">CHAIN REACTION</span>
        </div>
        <div class="general">
            <div class="bar-wrap">
                <canvas id="bar"></canvas>
            </div>
            <div id="interface">
                <canvas id="dynamic" width="450px" height="450px"></canvas>
                <canvas id="static" width="450px" height="450px"></canvas>
                <canvas id="grid" width="450px" height="450px"></canvas>
            </div>
        </div>
        <div>
            <div class="noSelect"><h2 id="userColor"></h2></div>
            <div class="noSelect">Your Pin is {{ .Pin }}</div>
            <div class="noSelect">Your Room is {{ .Room }}</div>
            <div class="noSelect" id="winner"></div>
            {{ if .Leader }}
            <div id="boardMatrix">
                <label for="rows" class="noSelect">Rows</label><br>
                <input type="text" id="rows" name="rows" value="8"><br>
                <label for="columns" class="noSelect">Columns</label><br>
                <input type="text" id="columns" name="columns" value="8"><br>
                <br>
                <button id="boardBtn" class="ent">Enter</button>
            </div>
            {{ end }}
        </div>
    </div>
    <div id="waitingRoom" class="noSelect">
        <div class="wait-title">
            <h2>Chain Reaction</h2>
        </div>
        <div class="wait-current">
            <div id="players">{{ .Players }}</div>
            <div>/</div>
            <div id="max">{{ .Max }}</div>
        </div>

        <div>
            <div class="lds-roller">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
        <div class="ent-ext">
            {{if .Leader}}
            <button id="entBtn" class="ent">Start</button>
            {{ end }}
            <button class="ext">Exit</button>
        </div>
    </div>
</body>
<script src="/static/js/board.js"></script>
<script>
    // start is the only new variable
    // true when game is ok to start.
    let goHome = document.querySelector(".navHome")
    let ext = document.querySelector(".ext")
    let userColor = document.getElementById("userColor")
    let path = document.location.pathname
    let id = path.slice(path.length - 8)
    let players = document.getElementById("players")
    let waiting = document.getElementById("waitingRoom");
    let winner = document.getElementById("winner");
    let socket = new WebSocket("wss://" + document.location.host + "/ws/" + id);
    let chain = new chainReaction(8, 8, "red");
    bar.canvas.width = chain.canvas.width;
// height is 10% of width
bar.canvas.height = bar.canvas.width * 0.05;
    goHome.onclick = () => document.location.href = "https://" + document.location.host
    ext.onclick = () => document.location.href = "https://" + document.location.host
    chain.grctx.canvas.onclick = (event) => {
        if (chain.state === true && start === true) {
        let canvasObj = event.target.getBoundingClientRect();
        // Get the square coords clicked
        let x = Math.floor((event.clientX - canvasObj.left) / chain.squareLength);
        let y = Math.floor((event.clientY - canvasObj.top) / chain.squareLength);
            socket.send(JSON.stringify({ type: "move", x: x, y: y}))
        }
    }
    socket.onmessage = (e) => {
        let data = JSON.parse(e.data);
        switch (data.type.toLowerCase()) {
            case "start":
                start = true
                waiting.style.display = "none";
                winner.innerHTML = "";
                chain.color = data.turn;
                chain.rows = data.rows;
                chain.cols = data.cols;
                chain.squareLength = Math.min(screen.height * .80 / chain.rows, screen.height * .80 / chain.cols);
                chain.initBoard();
                changeBarC(data.turn);
                break;
            case "move":
                // handle when person leaves.
                if (data.animation.length === 0) {
                    // Made a move, no explosion
                    chain.draw(...data.static[0][0]);
                    chain.color = data.turn;
                    changeBarC(data.turn);
                } else if (data.static.length === 0) {
                    // A person left the game
                    chain.color = data.turn;
                    changeBarC(data.turn);
                } else {
                    // We have an explosion
                    chain.state = false;
                    chain.draw(...data.static[0][0]);
                    requestAnimationFrame((ts) => chain.animate(
                            data.animation, data.static, ts, ts, 0, data.turn));
                }
                break;
            case "color":
                if (data.type !== "color") {return}
                chain.mycolor = data.color;
                userColor.style.color = data.color;
                userColor.innerHTML = `Your color is ${data.color}`;
                break;
            case "update":
                players.innerHTML = data.players;
                break;
            case "changecolor":
                chain.color = data.turn;
                changeBarC(data.turn);
                break;
            case "end":
                console.log(`The winner is ${data.winner}`);
                start = false;
                waiting.style.display = "";
                winner.innerHTML = `The winner is ${data.winner}!!`;
                winner.style.color = data.winner;
        }
    };
    chain.initBoard();
</script>
{{if .Leader}}
<script>
    let rows = document.getElementById("rows");
    let cols = document.getElementById("columns");
    let boardBtn = document.getElementById("boardBtn");
    boardBtn.onclick = () => {
        // Size bouds for cols and rows is [5, 30]
        if (start === true) { return }
        chain.rows = rows.value !== "" ? Math.max(5, parseInt(rows.value)) : 5;
        chain.cols = cols.value !== "" ? Math.max(5, parseInt(cols.value)) : 5;
        if (chain.rows > 30) {
            chain.rows = 30;
            rows.value = "30";
        }
        if (chain.cols > 30) {
            chain.cols = 30;
            cols.value = "30";
        }
        chain.squareLength = Math.min(screen.height * .80 / chain.rows, screen.height * .80 / chain.cols);
        chain.initBoard();
    }
    let enter = document.querySelector("#entBtn");
    // Start the game.
    if (enter !== null && start !== true) {
        enter.onclick = () => {
            if (parseInt(players.innerText) >= 2) {
                socket.send(JSON.stringify({
                type: "start",
                cols: chain.cols,
                rows: chain.rows,
            }));
            }
        }
    }
</script>
{{end}}

</html>